<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ÄÄƒng kÃ½ trá»±c cÆ¡m â€” Báº£ng tuáº§n</title>

<style>
  :root{
    --bg:#071021; --card:#0b1220; --accent:#6b46c1; --muted:#9aa4b2; --text:#e6eef6;
    --accent2:#3b82f6; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#061326,#081428);color:var(--text);padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:8px;align-items:center}
  .board-wrap{overflow:auto}
  .board{display:grid;grid-template-columns:repeat(6, 1fr);gap:12px}
  .col{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);min-height:160px}
  .col h3{margin:0 0 8px 0;font-size:14px;color:#cbd5e1;text-align:center}
  .shift{background:#071428;border-radius:8px;padding:8px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03)}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .title{font-weight:600}
  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:99px;overflow:hidden;margin-bottom:8px}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
  .list{display:flex;flex-direction:column;gap:6px}
  .person{background:rgba(255,255,255,0.02);padding:6px;border-radius:6px;display:flex;align-items:center;gap:8px;justify-content:space-between}
  .avatar{width:28px;height:28px;border-radius:999px;background:#1f2937;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  .btn{margin-top:8px;border:none;padding:8px 10px;border-radius:8px;background:var(--accent);color:white;cursor:pointer;width:100%;transition:opacity 0.3s ease}
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  .delete-btn{color:var(--danger);cursor:pointer;font-weight:bold;margin-left:8px}
  footer{margin-top:14px;color:var(--muted);font-size:13px}
  .admin-panel{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}
  #statusBanner{padding:10px;text-align:center;border-radius:8px;margin-bottom:10px;font-weight:600}
  [title]{position:relative}
  [title]:hover::after{
    content:attr(title);
    position:absolute;
    bottom:120%;
    left:50%;
    transform:translateX(-50%);
    background:#111;
    color:#fff;
    font-size:12px;
    padding:4px 8px;
    border-radius:4px;
    white-space:nowrap;
    opacity:0.9;
  }
  @media(max-width:1100px){ .board{grid-template-columns:repeat(3, 1fr)} }
  @media(max-width:720px){ .board{grid-template-columns:repeat(1, 1fr)} header{flex-direction:column;align-items:flex-start} }
</style>
</head>

<body>
<header>
  <div>
    <h1>ÄÄƒng kÃ½ trá»±c cÆ¡m â€” Báº£ng tuáº§n</h1>
    <div class="small">Thá»© 2 â†’ Thá»© 7 (SÃ¡ng/Chiá»u). ThÃªm: Chiá»u Chá»§ Nháº­t. Má»—i ca tá»‘i Ä‘a 3 ngÆ°á»i.</div>
  </div>
  <div class="controls">
    <div class="admin-panel">
      <button id="adminBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px">ÄÄƒng nháº­p Admin</button>
      <button id="resetBtn" class="btn" style="background:var(--danger);display:none">ğŸ”„ Reset Tuáº§n (Admin)</button>
      <button id="logoutBtn" class="btn" style="background:#374151;display:none">ğŸšª ÄÄƒng xuáº¥t</button>
    </div>
  </div>
</header>

<div id="statusBanner"></div>
<div class="board-wrap"><div id="board" class="board"></div></div>
<footer>Ghi chÃº: Báº¥m "ÄÄƒng kÃ½" â†’ nháº­p tÃªn. Báº¥m âŒ Ä‘á»ƒ xÃ³a tÃªn cá»§a chÃ­nh báº¡n. Há»‡ thá»‘ng cáº­p nháº­t realtime.</footer>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCZ8o7Z855RhsncCZlEt4zDe6ps-29RAq0",
    authDomain: "lich-truc-com.firebaseapp.com",
    databaseURL: "https://lich-truc-com-default-rtdb.firebaseio.com",
    projectId: "lich-truc-com",
    storageBucket: "lich-truc-com.firebasestorage.app",
    messagingSenderId: "769659188277",
    appId: "1:769659188277:web:da5226a15dbc0f87d46d7c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const shiftsRef = db.ref('shifts');

  const days = [
    { label: "Thá»© 2", key: "thu2" },
    { label: "Thá»© 3", key: "thu3" },
    { label: "Thá»© 4", key: "thu4" },
    { label: "Thá»© 5", key: "thu5" },
    { label: "Thá»© 6", key: "thu6" },
    { label: "Thá»© 7", key: "thu7" },
    { label: "Chá»§ Nháº­t", key: "cn" }
  ];
  const slotsDefault = [{ id: "ca1", title: "SÃ¡ng" }, { id: "ca2", title: "Chiá»u" }];
  const slotsCN = [{ id: "ca2", title: "Chiá»u" }];
  const MAX = 3;

  const board = document.getElementById('board');
  const resetBtn = document.getElementById('resetBtn');
  const adminBtn = document.getElementById('adminBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const statusBanner = document.getElementById('statusBanner');

  function buildGrid() {
    board.innerHTML = '';
    days.forEach(day => {
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `<h3>${day.label}</h3>`;
      const slots = (day.key === 'cn') ? slotsCN : slotsDefault;
      slots.forEach(s => {
        const shiftId = `${day.key}_${s.id}`;
        col.innerHTML += `
          <div class="shift">
            <div class="meta"><div class="title">${s.title}</div></div>
            <div class="progress"><div class="bar" id="bar_${shiftId}"></div></div>
            <div class="list" id="list_${shiftId}"></div>
            <button class="btn" id="btn_${shiftId}" onclick="onRegister('${shiftId}')">ÄÄƒng kÃ½</button>
          </div>`;
      });
      board.appendChild(col);
    });
  }
  buildGrid();

  shiftsRef.on('value', snap => {
    const data = snap.val() || {};
    days.forEach(day => {
      const slots = (day.key === 'cn') ? slotsCN : slotsDefault;
      slots.forEach(s => updateShiftUI(`${day.key}_${s.id}`, data[`${day.key}_${s.id}`] || []));
    });
  });

  function updateShiftUI(id, arr) {
    const listEl = document.getElementById('list_' + id);
    const barEl = document.getElementById('bar_' + id);
    const btnEl = document.getElementById('btn_' + id);
    const myName = localStorage.getItem('myName');
    listEl.innerHTML = '';
    arr.forEach(name => {
      const p = document.createElement('div');
      p.className = 'person';
      p.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px">
          <div class="avatar">${name.slice(0,1).toUpperCase()}</div>
          <div>${name}</div>
        </div>`;
      if (myName && myName === name) {
        const del = document.createElement('span');
        del.className = 'delete-btn';
        del.textContent = 'âŒ';
        del.onclick = () => removeSelfFromShift(id, name);
        p.appendChild(del);
      }
      listEl.appendChild(p);
    });
    const pct = Math.min(100, (arr.length / MAX) * 100);
    barEl.style.width = pct + '%';
    btnEl.disabled = arr.length >= MAX;
    btnEl.textContent = arr.length >= MAX ? 'ÄÃ£ Ä‘áº§y' : 'ÄÄƒng kÃ½';
  }

  function onRegister(shiftId) {
    if (!isRegistrationOpen() && !sessionStorage.getItem('isAdmin')) {
      alert("ğŸ”’ NgoÃ i giá» Ä‘Äƒng kÃ½ (chá»‰ má»Ÿ 19:50 Thá»© 6 â†’ 21:00 Thá»© 7)");
      return;
    }

    let name = localStorage.getItem('myName');
    if (!name) {
      name = prompt('Nháº­p tÃªn cá»§a báº¡n:').trim();
      if (!name) return;
      localStorage.setItem('myName', name);
    }
    const ref = db.ref('shifts/' + shiftId);
    ref.transaction(current => {
      if (!current) current = [];
      if (current.includes(name) || current.length >= MAX) return current;
      current.push(name);
      return current;
    });
  }

  function removeSelfFromShift(shiftId, name) {
    if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a "${name}" khá»i ca nÃ y?`)) return;
    const ref = db.ref('shifts/' + shiftId);
    ref.transaction(current => {
      if (!current) return current;
      return current.filter(n => n !== name);
    });
  }

  const ADMIN_PASSWORD = "Anbinh123";
  function setAdminMode(on) {
    if (on) {
      resetBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'inline-block';
      adminBtn.style.display = 'none';
      sessionStorage.setItem('isAdmin', 'true');
    } else {
      resetBtn.style.display = 'none';
      logoutBtn.style.display = 'none';
      adminBtn.style.display = 'inline-block';
      sessionStorage.removeItem('isAdmin');
    }
  }
  adminBtn.onclick = () => {
    const pass = prompt('Nháº­p máº­t kháº©u Admin:');
    if (pass === ADMIN_PASSWORD) {
      alert('âœ… ÄÃ£ Ä‘Äƒng nháº­p Admin');
      setAdminMode(true);
    } else alert('âŒ Sai máº­t kháº©u');
  };
  logoutBtn.onclick = () => { alert('ğŸšª ÄÃ£ Ä‘Äƒng xuáº¥t'); setAdminMode(false); };
  resetBtn.onclick = () => {
    if (!confirm('Reset toÃ n bá»™ lá»‹ch tuáº§n?')) return;
    const updates = {};
    days.forEach(day => {
      const slots = (day.key === 'cn') ? slotsCN : slotsDefault;
      slots.forEach(s => updates[`${day.key}_${s.id}`] = []);
    });
    shiftsRef.set(updates);
  };
  if (sessionStorage.getItem('isAdmin') === 'true') setAdminMode(true);

  function isRegistrationOpen() {
    const now = new Date();
    const day = now.getDay();
    const hour = now.getHours();
    const minute = now.getMinutes();
    return (day === 5 && (hour > 19 || (hour === 19 && minute >= 50))) ||
           (day === 6 && (hour < 21 || (hour === 21 && minute === 0)));
  }

  function updateButtonStates() {
    const isOpen = isRegistrationOpen() || sessionStorage.getItem('isAdmin');
    const buttons = document.querySelectorAll(".btn");
    buttons.forEach(btn => {
      if (["adminBtn","resetBtn","logoutBtn"].includes(btn.id)) return;
      btn.disabled = !isOpen;
      btn.style.opacity = isOpen ? "1" : "0.45";
      btn.title = isOpen ? "" : "NgoÃ i giá» Ä‘Äƒng kÃ½";
    });
    if (isOpen) {
      statusBanner.style.background = "rgba(16,185,129,0.15)";
      statusBanner.style.color = "#10b981";
      statusBanner.textContent = "ğŸŸ¢ Äang trong thá»i gian Ä‘Äƒng kÃ½";
    } else {
      statusBanner.style.background = "rgba(239,68,68,0.15)";
      statusBanner.style.color = "#ef4444";
      statusBanner.textContent = "ğŸ”’ NgoÃ i giá» Ä‘Äƒng kÃ½ (sáº½ má»Ÿ 19:50 Thá»© 6)";
    }
  }
  updateButtonStates();
  setInterval(updateButtonStates, 60000);

  /* === GHI Lá»ŠCH Sá»¬ ÄÄ‚NG NHáº¬P ADMIN (EMAIL + IP + THIáº¾T Bá»Š, CHá»ˆ ADMIN XEM) === */
  (function () {
    const logsRef = db.ref("admin_logins");

    async function getIP() {
      try {
        const res = await fetch("https://api.ipify.org?format=json");
        const data = await res.json();
        return data.ip;
      } catch {
        return "unknown";
      }
    }

    function getDeviceType() {
      const ua = navigator.userAgent;
      if (/mobile/i.test(ua)) return "ğŸ“± Mobile";
      if (/tablet/i.test(ua)) return "ğŸ“± Tablet";
      return "ğŸ’» Desktop";
    }

    const originalAdminClick = adminBtn.onclick;
    adminBtn.onclick = async () => {
      const pass = prompt("Nháº­p máº­t kháº©u Admin:");
      if (pass === ADMIN_PASSWORD) {
        alert("âœ… ÄÃ£ Ä‘Äƒng nháº­p Admin");
        setAdminMode(true);

        const email = "admin@anbinh.system";
        const ip = await getIP();
        const device = getDeviceType();
        const time = new Date().toLocaleString("vi-VN", { timeZone: "Asia/Ho_Chi_Minh" });
        logsRef.push({ email, ip, device, time });
      } else {
        alert("âŒ Sai máº­t kháº©u");
      }
    };

    const historyBtn = document.createElement("button");
    historyBtn.textContent = "ğŸ“œ Xem lá»‹ch sá»­ Admin";
    historyBtn.className = "btn";
    historyBtn.style.background = "#2563eb";
    historyBtn.style.display = "none";
    historyBtn.style.marginLeft = "8px";
    document.querySelector(".admin-panel").appendChild(historyBtn);

    const modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.background = "rgba(0,0,0,0.6)";
    modal.style.display = "none";
    modal.style.alignItems = "center";
    modal.style.justifyContent = "center";
    modal.style.zIndex = "9999";

    modal.innerHTML = `
      <div style="background:#0b1220;border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;max-width:420px;width:90%;color:white;max-height:80vh;overflow:auto;">
        <h2 style="margin-top:0;text-align:center">ğŸ“œ Lá»‹ch sá»­ Ä‘Äƒng nháº­p Admin</h2>
        <div id="adminLogs" style="font-size:14px;line-height:1.6;margin-top:10px"></div>
        <div style="text-align:center;margin-top:15px;">
          <button id="closeModal" class="btn" style="background:#374151;width:auto;">ÄÃ³ng</button>
        </div>
      </div>`;
    document.body.appendChild(modal);

    logsRef.on("value", snap => {
      const data = snap.val();
      const logDiv = document.getElementById("adminLogs");
      if (!logDiv) return;
      logDiv.innerHTML = "";
      if (!data) {
        logDiv.innerHTML = "<p>ChÆ°a cÃ³ ai Ä‘Äƒng nháº­p admin.</p>";
        return;
      }
      const entries = Object.values(data).reverse();
      entries.forEach((log, i) => {
        const div = document.createElement("div");
        div.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
        div.style.padding = "6px 0";
        div.innerHTML = `
          <b>${i + 1}.</b> ${log.email}<br>
          ğŸ•’ <span style="color:#9ca3af">${log.time}</span><br>
          ğŸŒ IP: ${log.ip} &nbsp;&nbsp; ğŸ’» ${log.device}
        `;
        logDiv.appendChild(div);
      });
    });

    historyBtn.onclick = () => (modal.style.display = "flex");
    modal.querySelector("#closeModal").onclick = () => (modal.style.display = "none");

    function toggleHistoryBtn() {
      historyBtn.style.display = sessionStorage.getItem("isAdmin") ? "inline-block" : "none";
    }
    toggleHistoryBtn();
    window.addEventListener("storage", toggleHistoryBtn);
  })();
</script>
</body>
</html>
