<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ÄÄƒng kÃ½ trá»±c cÆ¡m â€” Báº£ng tuáº§n</title>

<style>
  :root {
    --bg:#071021; --card:#0b1220; --accent:#6b46c1; --muted:#9aa4b2; --text:#e6eef6;
    --accent2:#3b82f6; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(180deg,#061326,#081428);color:var(--text);padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .controls{display:flex;gap:8px;align-items:center}
  .board-wrap{overflow:auto}
  .board{display:grid;grid-template-columns:repeat(6, 1fr);gap:12px}
  .col{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:10px;padding:12px;border:1px solid rgba(255,255,255,0.03);min-height:160px}
  .col h3{margin:0 0 8px 0;font-size:14px;color:#cbd5e1;text-align:center}
  .shift{background:#071428;border-radius:8px;padding:8px;margin-bottom:10px;border:1px solid rgba(255,255,255,0.03)}
  .meta{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .title{font-weight:600}
  .progress{height:8px;background:rgba(255,255,255,0.03);border-radius:99px;overflow:hidden;margin-bottom:8px}
  .bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:0%}
  .list{display:flex;flex-direction:column;gap:6px}
  .person{background:rgba(255,255,255,0.02);padding:6px;border-radius:6px;display:flex;align-items:center;gap:8px;justify-content:space-between}
  .avatar{width:28px;height:28px;border-radius:999px;background:#1f2937;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  .btn{margin-top:8px;border:none;padding:8px 10px;border-radius:8px;background:var(--accent);color:white;cursor:pointer;width:100%;transition:opacity 0.3s ease}
  .btn[disabled]{opacity:.45;cursor:not-allowed}
  .delete-btn{color:var(--danger);cursor:pointer;font-weight:bold;margin-left:8px}
  footer{margin-top:14px;color:var(--muted);font-size:15px}
  .admin-panel{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .small{font-size:13px;color:var(--muted)}
  #statusBanner{padding:10px;text-align:center;border-radius:8px;margin-bottom:10px;font-weight:600}
  [title]{position:relative}
  [title]:hover::after{
    content:attr(title);
    position:absolute;
    bottom:120%;
    left:50%;
    transform:translateX(-50%);
    background:#111;
    color:#fff;
    font-size:12px;
    padding:4px 8px;
    border-radius:4px;
    white-space:nowrap;
    opacity:0.9;
  }
  @media(max-width:1100px){ .board{grid-template-columns:repeat(3, 1fr)} }
  @media(max-width:720px){ .board{grid-template-columns:repeat(1, 1fr)} header{flex-direction:column;align-items:flex-start} }
</style>
</head>

<body>
<header>
  <div>
    <h1>ÄÄƒng kÃ½ trá»±c cÆ¡m â€” Báº£ng tuáº§n</h1>
    <div class="small">Thá»© 2 â†’ Thá»© 7 (SÃ¡ng/Chiá»u). ThÃªm: Chiá»u Chá»§ Nháº­t. Má»—i ca tá»‘i Ä‘a 3 ngÆ°á»i.</div>
  </div>
  <div class="controls">
    <div class="admin-panel">
      <button id="adminBtn" class="btn" style="background:transparent;border:1px solid rgba(255,255,255,0.06);padding:6px 10px">ÄÄƒng nháº­p Admin</button>
      <button id="resetBtn" class="btn" style="background:var(--danger);display:none">ğŸ”„ Reset Tuáº§n (Admin)</button>
      <button id="toggleOpenBtn" class="btn" style="background:#10b981;display:none">ğŸŸ¢ Má»Ÿ Ä‘Äƒng kÃ½ ngoÃ i giá»</button>
      <button id="logoutBtn" class="btn" style="background:#374151;display:none">ğŸšª ÄÄƒng xuáº¥t</button>
    </div>
  </div>
</header>

<div id="statusBanner"></div>
<div class="board-wrap"><div id="board" class="board"></div></div>
<footer>Ghi chÃº: Báº¥m "ÄÄƒng kÃ½" â†’ nháº­p tÃªn. Báº¥m âŒ Ä‘á»ƒ xÃ³a tÃªn cá»§a chÃ­nh báº¡n (hoáº·c Admin cÃ³ thá»ƒ xÃ³a báº¥t ká»³ tÃªn nÃ o). Há»‡ thá»‘ng cáº­p nháº­t realtime.</footer>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
  // Cáº¥u hÃ¬nh Firebase (giá»¯ nguyÃªn cá»§a báº¡n)
  const firebaseConfig = {
    apiKey: "AIzaSyCZ8o7Z855RhsncCZlEt4zDe6ps-29RAq0",
    authDomain: "lich-truc-com.firebaseapp.com",
    databaseURL: "https://lich-truc-com-default-rtdb.firebaseio.com",
    projectId: "lich-truc-com",
    storageBucket: "lich-truc-com.firebasestorage.app",
    messagingSenderId: "769659188277",
    appId: "1:769659188277:web:da5226a15dbc0f87d46d7c"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const shiftsRef = db.ref('shifts');
  const manualOpenRef = db.ref('manualOpen');
  const blacklistRef = db.ref('nameBlacklist');
  const adminNoteRef = db.ref('adminNote');
  let manualOpen = false;

  const days = [
    { label: "Thá»© 2", key: "thu2" },
    { label: "Thá»© 3", key: "thu3" },
    { label: "Thá»© 4", key: "thu4" },
    { label: "Thá»© 5", key: "thu5" },
    { label: "Thá»© 6", key: "thu6" },
    { label: "Thá»© 7", key: "thu7" },
    { label: "Chá»§ Nháº­t", key: "cn" }
  ];
  const slotsDefault = [{ id: "ca1", title: "SÃ¡ng" }, { id: "ca2", title: "Chiá»u" }];
  const slotsCN = [{ id: "ca2", title: "Chiá»u" }];
  const MAX = 3;

  const board = document.getElementById('board');
  const resetBtn = document.getElementById('resetBtn');
  const adminBtn = document.getElementById('adminBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const toggleOpenBtn = document.getElementById('toggleOpenBtn');
  const statusBanner = document.getElementById('statusBanner');

  // táº¡o nÃºt xÃ³a tÃªn mÃ¡y khÃ¡ch (Admin helper)
  const clearNameBtn = document.createElement('button');
  clearNameBtn.className = 'btn';
  clearNameBtn.style.background = '#f59e0b';
  clearNameBtn.style.display = 'none';
  clearNameBtn.textContent = 'ğŸ§¹ XÃ³a tÃªn mÃ¡y khÃ¡ch';
  document.querySelector('.admin-panel').appendChild(clearNameBtn);

  clearNameBtn.onclick = () => {
    const nameToRemove = prompt('Nháº­p tÃªn cáº§n xÃ³a trÃªn mÃ¡y khÃ¡ch:');
    if (!nameToRemove) return;
    blacklistRef.child(nameToRemove).set(true);
    alert(`âœ… ÄÃ£ thÃªm "${nameToRemove}" vÃ o danh sÃ¡ch xoÃ¡`);
  };

  function buildGrid() {
    board.innerHTML = '';
    days.forEach(day => {
      const col = document.createElement('div');
      col.className = 'col';
      col.innerHTML = `<h3>${day.label}</h3>`;
      const slots = (day.key === 'cn') ? slotsCN : slotsDefault;
      slots.forEach(s => {
        const shiftId = `${day.key}_${s.id}`;
        col.innerHTML += `
          <div class="shift">
            <div class="meta"><div class="title">${s.title}</div></div>
            <div class="progress"><div class="bar" id="bar_${shiftId}"></div></div>
            <div class="list" id="list_${shiftId}"></div>
            <button class="btn" id="btn_${shiftId}" onclick="onRegister('${shiftId}')">ÄÄƒng kÃ½</button>
          </div>`;
      });
      board.appendChild(col);
    });
  }
  buildGrid();

  shiftsRef.on('value', snap => {
    const data = snap.val() || {};
    days.forEach(day => {
      const slots = (day.key === 'cn') ? slotsCN : slotsDefault;
      slots.forEach(s => updateShiftUI(`${day.key}_${s.id}`, data[`${day.key}_${s.id}`] || []));
    });
  });

  function updateShiftUI(id, arr) {
    const listEl = document.getElementById('list_' + id);
    const barEl = document.getElementById('bar_' + id);
    const btnEl = document.getElementById('btn_' + id);
    const myName = localStorage.getItem('myName');
    if (!listEl || !barEl || !btnEl) return;
    listEl.innerHTML = '';
    arr.forEach(name => {
      const p = document.createElement('div');
      p.className = 'person';
      p.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px">
          <div class="avatar">${name.slice(0,1).toUpperCase()}</div>
          <div>${name}</div>
        </div>`;
      if ((myName && myName === name) || sessionStorage.getItem('isAdmin')) {
        const del = document.createElement('span');
        del.className = 'delete-btn';
        del.textContent = 'âŒ';
        del.title = sessionStorage.getItem('isAdmin') ? 'XÃ³a ngÆ°á»i nÃ y (Admin)' : 'XÃ³a tÃªn cá»§a báº¡n';
        del.onclick = () => {
          if (sessionStorage.getItem('isAdmin')) {
            if (!confirm(`âš ï¸ Admin xÃ¡c nháº­n xÃ³a "${name}" khá»i ca nÃ y?`)) return;
          } else {
            if (!confirm(`Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a "${name}" khá»i ca nÃ y?`)) return;
          }
          removeSelfFromShift(id, name);
        };
        p.appendChild(del);
      }
      listEl.appendChild(p);
    });
    const pct = Math.min(100, (arr.length / MAX) * 100);
    barEl.style.width = pct + '%';
    btnEl.disabled = arr.length >= MAX;
    btnEl.textContent = arr.length >= MAX ? 'ÄÃ£ Ä‘áº§y' : 'ÄÄƒng kÃ½';
  }

  function onRegister(shiftId) {
    if (!isRegistrationOpen() && !sessionStorage.getItem('isAdmin')) {
      alert("ğŸ”’ NgoÃ i giá» Ä‘Äƒng kÃ½ (chá»‰ má»Ÿ 19:50 Thá»© 6 â†’ 21:00 Thá»© 7 hoáº·c admin má»Ÿ thá»§ cÃ´ng)");
      return;
    }
    let name = localStorage.getItem('myName');
    if (!name) {
      name = prompt('Nháº­p tÃªn cá»§a báº¡n:');
      if (!name) return;
      name = name.trim();
      if (!name) return;
      localStorage.setItem('myName', name);
    }
    const ref = db.ref('shifts/' + shiftId);
    ref.transaction(current => {
      if (!current) current = [];
      if (current.includes(name) || current.length >= MAX) return current;
      current.push(name);
      return current;
    });
  }

  function removeSelfFromShift(shiftId, name) {
    const ref = db.ref('shifts/' + shiftId);
    ref.transaction(current => {
      if (!current) return current;
      return current.filter(n => n !== name);
    });
  }

  const ADMIN_PASSWORD = "Anbinh123";

  // âœ… Bá»” SUNG: HÃ m cáº­p nháº­t tráº¡ng thÃ¡i UI cá»§a nÃºt Má»Ÿ/Táº¯t ngoÃ i giá»
  function updateToggleOpenBtnUI() {
    toggleOpenBtn.textContent = manualOpen ? "ğŸ”´ Táº¯t má»Ÿ ngoÃ i giá»" : "ğŸŸ¢ Má»Ÿ Ä‘Äƒng kÃ½ ngoÃ i giá»";
    toggleOpenBtn.style.background = manualOpen ? "#ef4444" : "#10b981";
  }

  // LÆ¯U Ã: thay vÃ¬ dÃ¹ng biáº¿n DOM 'adminNoteInput' cÃ³ thá»ƒ chÆ°a tá»“n táº¡i,
  // ta truy váº¥n trá»±c tiáº¿p khi cáº§n Ä‘á»ƒ trÃ¡nh lá»—i "undefined" lÃ m dá»«ng script.
  function setAdminMode(on) {
    const adminNoteInputEl = document.getElementById('adminNoteInput'); // cÃ³ thá»ƒ null náº¿u DOM chÆ°a load pháº§n admin note
    if (on) {
      resetBtn.style.display = 'inline-block';
      logoutBtn.style.display = 'inline-block';
      adminBtn.style.display = 'none';
      toggleOpenBtn.style.display = 'inline-block';
      clearNameBtn.style.display = 'inline-block';
      sessionStorage.setItem('isAdmin', 'true');
      if (adminNoteInputEl) adminNoteInputEl.style.display = noteVisible ? "block" : "none";
    } else {
      resetBtn.style.display = 'none';
      logoutBtn.style.display = 'none';
      adminBtn.style.display = 'inline-block';
      toggleOpenBtn.style.display = 'none';
      clearNameBtn.style.display = 'none';
      sessionStorage.removeItem('isAdmin');
      if (adminNoteInputEl) adminNoteInputEl.style.display = "none";
    }

    // âœ… FIX 1: Äáº£m báº£o UI nÃºt toggleOpenBtn Ä‘Æ°á»£c cáº­p nháº­t ngay khi Admin login/logout
    updateToggleOpenBtnUI(); 
    updateButtonStates();
  }

  adminBtn.onclick = () => {
    const pass = prompt('Nháº­p máº­t kháº©u Admin:');
    if (pass === ADMIN_PASSWORD) { alert('âœ… ÄÃ£ Ä‘Äƒng nháº­p Admin'); setAdminMode(true); }
    else alert('âŒ Sai máº­t kháº©u');
  };
  logoutBtn.onclick = () => { alert('ğŸšª ÄÃ£ Ä‘Äƒng xuáº¥t'); setAdminMode(false); };
  resetBtn.onclick = () => {
    if (!confirm('Reset toÃ n bá»™ lá»‹ch tuáº§n?')) return;
    const updates = {};
    days.forEach(day => {
      const slots = (day.key === 'cn') ? slotsCN : slotsDefault;
      slots.forEach(s => updates[`${day.key}_${s.id}`] = []);
    });
    shiftsRef.set(updates);
  };
  if (sessionStorage.getItem('isAdmin') === 'true') setAdminMode(true);

  toggleOpenBtn.onclick = async () => {
    const newState = !manualOpen;
    await manualOpenRef.set(newState);
    // âœ… FIX 2: Bá» cáº­p nháº­t manualOpen vÃ  updateButtonStates á»Ÿ Ä‘Ã¢y.
    // Viá»‡c nÃ y sáº½ Ä‘Æ°á»£c xá»­ lÃ½ bá»Ÿi listener manualOpenRef.on('value', ...) bÃªn dÆ°á»›i Ä‘á»ƒ Ä‘áº£m báº£o Ä‘á»“ng bá»™ tá»« Firebase.
    alert(newState ? "âœ… ÄÃ£ báº­t Ä‘Äƒng kÃ½ ngoÃ i giá» cho má»i ngÆ°á»i" : "ğŸ”’ ÄÃ£ táº¯t Ä‘Äƒng kÃ½ ngoÃ i giá»");
  };

  manualOpenRef.on('value', snap => {
    manualOpen = !!snap.val();
    // âœ… FIX 3: Gá»i cáº­p nháº­t UI cho nÃºt toggleOpenBtn vÃ  cÃ¡c nÃºt Ä‘Äƒng kÃ½ khÃ¡c ngay khi giÃ¡ trá»‹ manualOpen thay Ä‘á»•i
    if (sessionStorage.getItem('isAdmin')) {
      updateToggleOpenBtnUI();
    }
    updateButtonStates();
  });

  blacklistRef.on('value', snap => {
    const list = snap.val() || {};
    const myName = localStorage.getItem('myName');
    if (myName && list[myName]) {
      alert('âš ï¸ TÃªn cÅ© cá»§a báº¡n Ä‘Ã£ bá»‹ admin xoÃ¡, vui lÃ²ng nháº­p láº¡i tÃªn má»›i.');
      localStorage.removeItem('myName');
    }
  });

  function isRegistrationOpen() {
    if (manualOpen) return true;
    const now = new Date();
    const day = now.getDay(); // 0 CN, 1 T2, ..., 6 T7
    const hour = now.getHours();
    const minute = now.getMinutes();
    return (day === 5 && (hour > 19 || (hour === 19 && minute >= 50))) ||
           (day === 6 && (hour < 21 || (hour === 21 && minute === 0)));
  }

  function updateButtonStates() {
    // --- CHá»ˆ Sá»¬A NHá» á» ÄÃ‚Y: Ä‘áº£m báº£o so sÃ¡nh isAdmin Ä‘Ãºng vÃ  so sÃ¡nh trá»±c tiáº¿p nÃºt Ä‘á»ƒ khÃ´ng vÃ´ tÃ¬nh disable toggleOpenBtn ---
    const isOpen = isRegistrationOpen() || sessionStorage.getItem('isAdmin') === 'true';
    const buttons = document.querySelectorAll(".btn");
    buttons.forEach(btn => {
      // skip the admin control buttons and the dynamically created clearNameBtn by direct reference
      if (btn === adminBtn || btn === resetBtn || btn === logoutBtn || btn === toggleOpenBtn || btn === clearNameBtn) return;
      btn.disabled = !isOpen;
      btn.style.opacity = isOpen ? "1" : "0.45";
      btn.title = isOpen ? "" : "NgoÃ i giá» Ä‘Äƒng kÃ½";
    });
    if (isOpen) {
      statusBanner.style.background = "rgba(16,185,129,0.15)";
      statusBanner.style.color = "#10b981";
      statusBanner.textContent = manualOpen ? "ğŸŸ¢ ÄÄƒng kÃ½ Ä‘ang má»Ÿ (Admin báº­t thá»§ cÃ´ng)" : "ğŸŸ¢ Äang trong thá»i gian Ä‘Äƒng kÃ½";
    } else {
      statusBanner.style.background = "rgba(239,68,68,0.15)";
      statusBanner.style.color = "#ef4444";
      statusBanner.textContent = "ğŸ”’ NgoÃ i giá» Ä‘Äƒng kÃ½ (sáº½ má»Ÿ 19:50 Thá»© 6)";
    }
  }
  updateButtonStates();
  setInterval(updateButtonStates, 60000);
</script>

<div id="adminNoteToggle">ğŸ“</div>
<div id="adminNoteBox">
  <textarea id="adminNoteInput" placeholder="âœï¸ Nháº­p ghi chÃº cho má»i ngÆ°á»i..."></textarea>
  <div id="adminNoteDisplay">ğŸ“ <span id="adminNoteText">KhÃ´ng cÃ³ ghi chÃº nÃ o</span></div>
</div>

<style>
  #adminNoteToggle {
    position: fixed;
    bottom: 18px;
    right: 18px;
    background: var(--accent);
    color: white;
    padding: 10px;
    border-radius: 50%;
    font-size: 22px;
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 10;
    transition: all 0.3s ease;
  }
  #adminNoteToggle:hover { transform: scale(1.1); }

  #adminNoteBox {
    position: fixed;
    bottom: 80px;
    right: 18px;
    background: var(--card);
    border: 1px solid rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 12px;
    width: 260px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    z-index: 9;
    display: none;
  }
  #adminNoteInput {
    width: 100%;
    height: 100px;
    border: none;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    color: white;
    padding: 8px;
    display: none;
    resize: none;
  }
  #adminNoteDisplay { font-size: 14px; line-height: 1.5; color: var(--muted); }
</style>

<script>
  // Biáº¿n DOM cho admin note, Ä‘Æ°á»£c sá»­ dá»¥ng á»Ÿ pháº§n UI admin note (Ä‘Ã¢y sáº½ tá»“n táº¡i vÃ¬ pháº§n HTML admin note Ä‘Ã£ xuáº¥t hiá»‡n trÆ°á»›c script nÃ y).
  const adminNoteToggle = document.getElementById('adminNoteToggle');
  const adminNoteBox = document.getElementById('adminNoteBox');
  const adminNoteInput = document.getElementById('adminNoteInput');
  const adminNoteDisplay = document.getElementById('adminNoteDisplay');
  const adminNoteText = document.getElementById('adminNoteText');
  let noteVisible = false;

  adminNoteToggle.onclick = () => {
    noteVisible = !noteVisible;
    adminNoteBox.style.display = noteVisible ? "block" : "none";
    if (sessionStorage.getItem('isAdmin')) {
      if (adminNoteInput) adminNoteInput.style.display = noteVisible ? "block" : "none";
    }
  };

  adminNoteRef.on('value', snap => {
    const text = snap.val() || "KhÃ´ng cÃ³ ghi chÃº nÃ o";
    if (adminNoteText) adminNoteText.textContent = text;
  });

  if (adminNoteInput) {
    adminNoteInput.oninput = e => {
      const txt = e.target.value.trim();
      adminNoteRef.set(txt);
    };
  }
</script>

</body>
</html>
